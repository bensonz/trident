---
- name: "upload certificates for worker"
  copy:
    src: "{{playbook_dir}}/{{secrets_dir}}/{{item}}.pem"
    dest: "/etc/kubernetes/ssl/{{item}}.pem"
    owner: root
    mode: 0644
  with_items:
    - ca
    - etcd
    - etcd-key
    - kube-worker
    - kube-worker-key
    - kube-proxy
    - kube-proxy-key

- name: "upload kubernetes config"
  template:
    src: "{{playbook_dir}}/{{role_dir}}/files/templates/{{item}}.j2"
    dest: "/etc/kubernetes/manifests/{{item}}"
    owner: root
    mode: 0644
  with_items:
    - kube-proxy.yml
    - worker-kubeconfig.yml
    - proxy-kubeconfig.yml

- name: "upload kubelet.service"
  template:
    src: "{{playbook_dir}}/{{role_dir}}/files/templates/kubelet.service.j2"
    dest: "/etc/systemd/system/kubelet.service"
    owner: root
    mode: 0644

- name: "upload etcd environments"
  template:
    src: "{{playbook_dir}}/{{role_dir}}/files/environment"
    dest: "/etc/environment"
    owner: root
    mode: 0644

# Start all
- name: Reloading daemon
  command: "systemctl daemon-reload"

- name: Ensure kubelet is started
  service:
    name: "{{item}}"
    state: started
  with_items:
    - kubelet

# ###################################
# Common setup for all ec2 instances
# ###################################
---

- name: "Check if need to install python"
  raw: "stat /opt/python/.bootstrapped"
  register: need_bootstrap
  ignore_errors: True
  changed_when: false

- name: "scp python tar file"
  become: no
  local_action : "command scp {{playbook_dir}}/{{role_dir}}/files/python/pypy.tar.bz2 core@{{inventory_hostname}}:/tmp/pypy.tar.bz2"
  when: need_bootstrap | failed

- name: "scp bootstrap.sh"
  become: no
  local_action : "command scp {{playbook_dir}}/{{role_dir}}/files/python/bootstrap.sh core@{{inventory_hostname}}:/tmp/bootstrap.sh"
  when: need_bootstrap | failed

- name: "run bootstrap"
  become: yes
  raw: "PYTHON_VERSION={{python_version}} PYPY_VERSION={{pypy_version}} sh /tmp/bootstrap.sh"
  when: need_bootstrap | failed

- name: "Set bootstrapped file"
  file:
    path: /opt/python/.bootstrapped
    state: touch
  changed_when: false

- name: "upload docker-login-gen"
  become: yes
  copy:
    src: "{{playbook_dir}}/{{role_dir}}/files/docker-login-gen"
    dest: "/opt/bin/docker-login-gen"
    owner: root
    mode: 0755

- name: "upload 01-wait-for-certs.conf to etcd2"
  copy:
    src: "{{playbook_dir}}/{{role_dir}}/files/01-wait-for-certs.conf"
    dest: "/etc/systemd/system/etcd2.service.d/01-wait-for-certs.conf"
    owner: root
    mode: 0644

- name: "create locksmithd.service.d"
  raw: "mkdir -p /etc/systemd/system/locksmithd.service.d"

- name: "upload 01-wait-for-certs.conf to locksmithd"
  copy:
    src: "{{playbook_dir}}/{{role_dir}}/files/01-wait-for-certs.conf"
    dest: "/etc/systemd/system/locksmithd.service.d/01-wait-for-certs.conf"
    owner: root
    mode: 0644

- name: "create flanneld.service.d"
  raw: "mkdir -p /etc/systemd/system/flanneld.service.d"

- name: "upload 50-network-config.conf"
  copy:
    src: "{{playbook_dir}}/{{role_dir}}/files/50-network-config.conf"
    dest: "/etc/systemd/system/flanneld.service.d/50-network-config.conf"
    owner: root
    mode: 0644

- name: "create docker.service.d"
  raw: "mkdir -p /etc/systemd/system/docker.service.d"

- name: "upload 40-flannel.conf to docker.service.d"
  copy:
    src: "{{playbook_dir}}/{{role_dir}}/files/40-flannel.conf"
    dest: "/etc/systemd/system/docker.service.d/40-flannel.conf"
    owner: root
    mode: 0644

- name: "Upload templated prefetch-flannel.service"
  template:
    src: "{{playbook_dir}}/{{role_dir}}/files/templates/prefetch-flannel.service"
    dest: "/etc/systemd/system/prefetch-flannel.service"
    owner: root
    mode: 0644

- name: "upload templated prefetch-docker-hyperkube.service"
  template:
    src:
      "{{playbook_dir}}/{{role_dir}}/files/templates/prefetch-docker-hyperkube.service"
    dest: "/etc/systemd/system/prefetch-docker-hyperkube.service"
    owner: root
    mode: 0644
